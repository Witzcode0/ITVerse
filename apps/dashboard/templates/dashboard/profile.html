{% extends 'dashboard/base.html' %}

{% block title %}
Profile
{% endblock %}

{% block style %}
<style>
    .ts-control {
        border-radius: 0.75rem;
        border: 1px solid #d1d5db;
        padding: 10px;
    }

    .ts-control.focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, .15);
    }

    .ts-control .item {
        background: #dbeafe;
        color: #1e40af;
        border-radius: 6px;
        padding: 3px 8px;
    }

    .ts-dropdown {
        border-radius: 12px;
    }
</style>

{% endblock %}

{% block body %}

<div class="min-h-screen bg-gray-100 py-10">
    <div class="max-w-5xl mx-auto bg-white shadow-lg rounded-2xl overflow-hidden">

        <!-- Header -->
        <div class="bg-blue-600 h-40 relative">

            <!-- Avatar -->
            <div class="absolute -bottom-16 left-8">
                <img src="{{user.profile.url}}" class="w-32 h-32 rounded-full border-4 border-white shadow-md">
            </div>

        </div>

        <!-- Content -->
        <div class="pt-20 pb-8 px-8">

            <div class="flex flex-col md:flex-row md:items-center md:justify-between">

                <!-- User Info -->
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">
                        {{user.fullname|title}} <!-- Role Badge -->
                        {% if user.user_type == "seller" %}
                        <span
                            class="inline-block mt-2 px-3 py-1 text-sm font-semibold text-white bg-green-500 rounded-full">
                            Seller
                        </span>
                        {% else %}
                        <span
                            class="inline-block mt-2 px-3 py-1 text-sm font-semibold text-white bg-purple-500 rounded-full">
                            Buyer
                        </span>
                        {% endif %}
                    </h2>

                    <a href="{% url 'connections' %}"
                        class="relative inline-flex items-center gap-2 mt-6 px-4 py-2 font-semibold text-gray-700 hover:text-blue-600 transition">

                        <!-- Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5V4H2v16h5m10 0v-4a4 4 0 00-8 0v4m8 0H9" />
                        </svg>

                        My connections

                        <!-- Count Badge -->
                        <span
                            class="absolute -top-1 -right-1 bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-full shadow">
                            {{ total_connections }}
                        </span>

                    </a>




                </div>

                <!-- Edit Button -->
                <button onclick="openModal()"
                    class="mt-4 md:mt-0 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow">
                    Edit Profile
                </button>

                <!-- Modal Background -->
                <div id="profileModal" class="fixed inset-0 bg-black/60 hidden 
     items-center justify-center z-50 p-4">

                    <!-- Modal Box -->
                    <div class="bg-white w-full max-w-lg sm:max-w-xl lg:max-w-2xl
                max-h-[90vh] rounded-2xl shadow-xl 
                flex flex-col">

                        <!-- Header -->
                        <div class="flex justify-between items-center border-b p-4 sm:p-5">
                            <h2 class="text-lg sm:text-xl font-bold">Edit Profile</h2>

                            <button onclick="closeModal()"
                                class="text-gray-500 hover:text-gray-800 text-2xl leading-none">
                                ✕
                            </button>
                        </div>

                        <!-- Scrollable Body -->
                        <div class="overflow-y-auto p-4 sm:p-6 flex-1">

                            <form action="{% url 'update_profile' %}" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}

                                <!-- OLD IMAGE PREVIEW -->
                                <div class="flex flex-col items-center mb-6">

                                    <img src="{{ user.profile.url }}" class="w-24 h-24 sm:w-28 sm:h-28 rounded-full 
                                object-cover border-4 border-gray-200 shadow">

                                    <p class="text-sm text-gray-500 mt-2">
                                        Current Profile Image
                                    </p>
                                </div>

                                <!-- FORM GRID -->
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

                                    <!-- Upload -->
                                    <div class="sm:col-span-2">
                                        <label class="text-sm text-gray-600">Change Profile Image</label>
                                        <input type="file" name="profile" class="w-full mt-1 p-2 border rounded-lg">
                                    </div>

                                    <!-- Fullname -->
                                    <div class="sm:col-span-2">
                                        <label class="text-sm text-gray-600">Fullname</label>
                                        <input type="text" name="fullname" value="{{user.fullname|title}}" class="w-full mt-1 p-2.5 border rounded-lg
                               focus:ring-2 focus:ring-blue-400 outline-none">
                                    </div>

                                    <!-- Email -->
                                    <div class="sm:col-span-2">
                                        <label class="text-sm text-gray-600">Email</label>
                                        <input type="email" name="email" value="{{user.email}}" class="w-full mt-1 p-2.5 border rounded-lg
                               focus:ring-2 focus:ring-blue-400 outline-none">
                                    </div>


                                    <!-- Mobile -->
                                    <div class="sm:col-span-2">
                                        <label class="text-sm text-gray-600">Mobile</label>
                                        <input type="text" name="mobile" value="{{user.mobile}}" class="w-full mt-1 p-2.5 border rounded-lg
                               focus:ring-2 focus:ring-blue-400 outline-none">
                                    </div>



                                </div>

                                <!-- Submit -->
                                <button type="submit" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 
                           text-white py-2.5 rounded-lg font-semibold
                           transition duration-200">
                                    Update Profile
                                </button>

                            </form>

                        </div>
                    </div>
                </div>


            </div>

            <!-- Divider -->
            <div class="border-t my-6"></div>

            <!-- Details Grid -->
            <div class="grid md:grid-cols-2 gap-6">

                <div class="bg-gray-50 p-5 rounded-xl">
                    <p class="text-gray-500 text-sm">Mobile</p>
                    <p class="font-semibold text-gray-800">
                        {{user.mobile}}
                    </p>
                </div>

                <div class="bg-gray-50 p-5 rounded-xl">
                    <p class="text-gray-500 text-sm">Email</p>
                    <p class="font-semibold text-gray-800">
                        {{user.email}}
                    </p>
                </div>

                <div class="bg-gray-50 p-5 rounded-xl">
                    <p class="text-gray-500 text-sm">User ID</p>
                    <p class="font-semibold text-gray-800">
                        {{user.id}}
                    </p>
                </div>

                <div class="bg-gray-50 p-5 rounded-xl">
                    <p class="text-gray-500 text-sm">Account Status</p>

                    {% if user.is_active %}
                    <span class="font-semibold text-green-600">Active</span>
                    {% else %}
                    <span class="font-semibold text-red-600">Deactive</span>
                    {% endif %}
                </div>

            </div>
            <div class="border-t my-6"></div>

            <!-- Tabs -->
            <div class="border-b mb-6">
                <div class="flex gap-6">

                    {% if user.user_type == "seller" %}
                    <button onclick="openTab('company')" class="tab-btn text-blue-600 border-b-2 border-blue-600 pb-2">
                        Company detail
                    </button>
                    {% endif %}

                    <button onclick="openTab('social')" class="tab-btn text-gray-500 hover:text-blue-600 pb-2">
                        Social Links
                    </button>

                </div>
            </div>
            {% if user.user_type == "seller" %}
            <div id="company" class="tab-content">

                <div class="bg-gray-100 p-6 rounded-2xl">

                    <form action="{% url 'add_company' %}" method="POST" enctype="multipart/form-data"
                        class="max-w-4xl mx-auto bg-white p-10 rounded-3xl shadow-xl space-y-8">

                        {% csrf_token %}

                        <!-- Title -->
                        <div class="border-b pb-4">
                            <h2 class="text-3xl font-bold text-gray-800">
                                Company Details
                            </h2>
                            <p class="text-gray-500 text-sm mt-1">
                                Keep your company information updated for better visibility.
                            </p>
                        </div>

                        <!-- Logo Upload -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Company Logo
                            </label>

                            <div class="flex items-center gap-6">

                                <!-- Preview -->
                                <div class="relative">
                                    <img id="logoPreview"
                                        src="{% if company and company.logo %}{{ company.logo.url }}{% else %}/media/default/company.png{% endif %}"
                                        class="w-24 h-24 rounded-2xl object-cover border-2 border-gray-200 shadow-sm">
                                </div>

                                <!-- Upload Button -->
                                <label
                                    class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl shadow transition">
                                    Change Logo
                                    <input type="file" name="logo" accept="image/*" onchange="previewLogo(event)"
                                        class="hidden">
                                </label>

                                <span class="text-sm text-gray-400">
                                    PNG or JPG recommended
                                </span>

                            </div>
                        </div>

                        <!-- Grid -->
                        <div class="grid md:grid-cols-2 gap-6">

                            <!-- Company Name -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Company Name
                                </label>

                                <input type="text" name="name" value="{{ company.name|default:'' }}"
                                    placeholder="Enter company name" class="w-full border-none border-gray-300 rounded-xl p-3
                                  focus:ring-2 focus:ring-blue-500
                                  focus:border-blue-500
                                  outline-none transition">
                            </div>

                            <!-- Address -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    Address
                                </label>

                                <input type="text" name="address" value="{{ company.address|default:'' }}"
                                    placeholder="Enter company address" class="w-full border-none border-gray-300 rounded-xl p-3
                                  focus:ring-2 focus:ring-blue-500
                                  focus:border-blue-500
                                  outline-none transition">
                            </div>

                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Company Description
                            </label>

                            <textarea name="content" rows="5" placeholder="Tell users about your company..." class="w-full border-none  rounded-xl p-3
                                 focus:ring-2 focus:ring-blue-500
                                 focus:border-blue-500
                                 outline-none transition">{{ company.content|default:'' }}</textarea>
                        </div>

                        <!-- Services -->
                        <div>
                            <div x-data="serviceSelect()" class="w-full">

                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Services
                                </label>

                                <!-- Chips Container -->
                                <div
                                    class="flex flex-wrap items-center gap-2 border-none rounded-xl p-2 focus-within:ring-2 focus-within:ring-blue-500">

                                    <!-- Selected Chips -->
                                    <template x-for="(service, index) in selected" :key="service">
                                        <span
                                            class="flex items-center gap-1 bg-blue-100 text-blue-700 px-3 py-1 rounded-lg text-sm">
                                            <span x-text="service"></span>

                                            <button type="button" @click="remove(index)"
                                                class="text-blue-500 hover:text-red-500 font-bold">
                                                ✕
                                            </button>

                                            <!-- Hidden input for Django -->
                                            <input type="hidden" name="services[]" :value="service">
                                        </span>
                                    </template>

                                    <!-- Input -->
                                    <input type="text" x-model="search" @input="filter()"
                                        @keydown.enter.prevent="createService()" placeholder="Type and press enter..."
                                        class="flex-1 outline-none p-1 min-w-[120px]">
                                </div>

                                <!-- Dropdown -->
                                <div x-show="filtered.length" @click.away="filtered=[]"
                                    class="bg-white border rounded-xl mt-2 shadow-lg max-h-60 overflow-y-auto">

                                    <template x-for="service in filtered" :key="service">
                                        <div @click="add(service)" class="px-4 py-2 hover:bg-blue-50 cursor-pointer">
                                            <span x-text="service"></span>
                                        </div>
                                    </template>
                                </div>

                            </div>


                            <p class="text-xs text-gray-400 mt-2">
                                Start typing to search or create new services.
                            </p>
                        </div>

                        <!-- Submit -->
                        <div class="pt-4">
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700
                               text-white py-3 rounded-2xl
                               font-semibold text-lg
                               shadow-md hover:shadow-lg
                               transition duration-200">

                                Save Company
                            </button>
                        </div>

                    </form>

                </div>
            </div>
            {% endif %}

            <div id="social" class="tab-content hidden">
                <div class="bg-gray-50 p-6 rounded-xl shadow-sm">

                    <form action="{% url 'add_social_link' %}" method="POST" class="space-y-5">
                        {% csrf_token %}

                        <!-- Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Social Media Name
                            </label>
                            <input type="text" name="name" placeholder="Example: Facebook, Instagram, LinkedIn"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                                required>
                        </div>

                        <!-- URL -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">
                                Profile URL
                            </label>
                            <input type="url" name="url" placeholder="https://example.com/yourprofile"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                                required>
                        </div>

                        <!-- Button -->
                        <div>
                            <button type="submit"
                                class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition">
                                Add Social Link
                            </button>
                        </div>

                    </form>

                    <!-- Existing Links -->
                    <div class="mt-6 border-t pt-4">
                        {% for link in social_links %}
                        <a href="{{ link.url }}" target="_blank" class="block text-blue-600 hover:underline mb-2">
                            {{ link.name }}
                        </a>
                        {% empty %}
                        <p class="text-gray-500">No links added.</p>
                        {% endfor %}
                    </div>

                </div>
            </div>


            <a href="{% url 'logout' %}"
                class="w-28 h-10 flex items-center my-6 justify-center bg-red-500 hover:bg-red-600 text-white">

                <i class="fa-solid fa-right-from-bracket"></i> &nbsp; Logout
            </a>



        </div>
    </div>
</div>
<script>
    function previewLogo(event) {
        const image = document.getElementById('logoPreview');
        image.src = URL.createObjectURL(event.target.files[0]);
    }
    function openModal() {
        const modal = document.getElementById('profileModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('profileModal');
        modal.classList.add('hidden');

        document.body.style.overflow = 'auto';
    }

    document.addEventListener("DOMContentLoaded", function () {
        openTab('company');
    });

    function openTab(tabId) {

        document.querySelectorAll('.tab-content')
            .forEach(tab => tab.classList.add('hidden'));

        document.querySelectorAll('.tab-btn')
            .forEach(btn => btn.classList.remove(
                'text-blue-600', 'border-blue-600', 'border-b-2'
            ));

        document.getElementById(tabId)
            .classList.remove('hidden');

        document.querySelector(`[onclick="openTab('${tabId}')"]`)
            .classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
    }

    function serviceSelect() {
        return {

            // Load from Django
            services: [
                {% for s in services %}
        "{{s.name}}",
            {% endfor %}
        ],

    selected: [
        {% if company_services_ %}
    {% for s in company_services_ %}
    "{{s.name}}",
        {% endfor %}
    {% endif %}
        ],

    search: "",
        filtered: [],

            filter() {
        if (this.search.length < 1) {
            this.filtered = [];
            return;
        }

        this.filtered = this.services.filter(s =>
            s.toLowerCase().includes(this.search.toLowerCase())
            && !this.selected.includes(s)
        );
    },

    add(service){
        this.selected.push(service);
        this.search = "";
        this.filtered = [];
    },

    remove(index){
        this.selected.splice(index, 1);
    },

    createService(){
        if (!this.search.trim()) return;

        if (!this.selected.includes(this.search)) {
            this.selected.push(this.search);
        }

        this.search = "";
        this.filtered = [];
    }
    }
}

</script>

{% endblock %}